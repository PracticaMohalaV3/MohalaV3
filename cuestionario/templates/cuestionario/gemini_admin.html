{% extends "cuestionario/base.html" %}

{% block title %}Panel de Generaci√≥n IA{% endblock %}

{% block content %}
<section>
    <header>
        <a href="{% url 'seguimiento_admin' %}" class="button small primary">‚Üê Volver a Seguimiento</a>
        
        <h2 style="margin-top: 1em;">Panel de Generaci√≥n de Informes con IA</h2>
        <p>Utiliza Gemini AI para generar informes personalizados</p>
    </header>

    <!-- BOT√ìN 1: EDITAR PROMPT -->
    <div style="background: rgba(255,255,255,0.05); padding: 2em; border-radius: 8px; margin-bottom: 2em;">
        <h3 style="color: #51ff85;">üìù Editar Prompt</h3>
        <form method="POST" action="{% url 'editar_prompt' %}">
            {% csrf_token %}
            <div class="row gtr-uniform">
                <div class="col-12">
                    <label for="prompt_texto"><strong>Escribe el prompt para la IA:</strong></label>
                    <textarea name="prompt_texto" id="prompt_texto" rows="8" 
                              placeholder="Ejemplo: Genera un informe ejecutivo sobre las evaluaciones de desempe√±o del √∫ltimo trimestre, incluyendo estad√≠sticas y recomendaciones..."
                              style="background: rgba(255,255,255,0.05); color: white;" required>{% if ultimo_prompt %}{{ ultimo_prompt.prompt_texto }}{% endif %}</textarea>
                </div>
                <div class="col-12">
                    <button type="submit" class="button primary">üíæ Guardar Nuevo Prompt</button>
                </div>
            </div>
        </form>
    </div>

    <!-- BOT√ìN 2: VER HISTORIAL -->
    <div style="background: rgba(255,255,255,0.05); padding: 2em; border-radius: 8px; margin-bottom: 2em;">
        <h3 style="color: #2196F3;">üìã Historial de Prompts</h3>
        
        {% if historial %}
        <div class="table-wrapper">
            <table class="alt">
                <thead>
                    <tr>
                        <th style="width: 8%;">ID</th>
                        <th style="width: 12%;">Fecha</th>
                        <th style="width: 40%;">Prompt</th>
                        <th style="width: 10%;">Estado</th>
                        <th style="width: 15%;">Generar Informe</th>
                        <th style="width: 15%;">Ver Informe</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prompt in historial %}
                    <tr>
                        <td style="text-align: center;"><strong>#{{ prompt.id_prompt }}</strong></td>
                        <td>{{ prompt.timestamp|date:"d/m/Y H:i" }}</td>
                        <td>
                            <small style="opacity: 0.8;">
                                {{ prompt.prompt_texto }}
                            </small>
                        </td>
                        <td style="text-align: center;">
                            {% if prompt.pdf_generado %}
                                <span style="color: #51ff85; font-weight: bold;">‚úì Generado</span>
                            {% else %}
                                <span style="opacity: 0.5;">‚è≥ Pendiente</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if prompt.pdf_generado %}
                                <button class="button small" disabled style="opacity: 0.4; cursor: not-allowed;">
                                    ‚úì Ya Generado
                                </button>
                            {% else %}
                                <a href="{% url 'generar_informe_gemini' prompt.id_prompt %}" 
                                   class="button small primary" 
                                   target="_blank">
                                    ü§ñ Generar Informe
                                </a>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if prompt.pdf_generado %}
                                <a href="{% url 'ver_informe_gemini' prompt.id_prompt %}" 
                                   class="button small primary" target="_blank">
                                    üìÑ Ver Informe
                                </a>
                            {% else %}
                                <span style="opacity: 0.3;">---</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="opacity: 0.5; text-align: center; padding: 2em;">
            No hay prompts guardados a√∫n. Crea uno usando el formulario de arriba.
        </p>
        {% endif %}
    </div>

    <!-- BOT√ìN 3: GENERAR INFORME (usando el √∫ltimo prompt) -->
    {% if ultimo_prompt %}
    <div style="text-align: center; margin-top: 2em; padding-bottom: 2em;">
        <a href="{% url 'generar_informe_gemini' ultimo_prompt.id_prompt %}" 
           class="button primary large" 
           target="_blank">
            üöÄ Generar Informe con √öltimo Prompt
        </a>
    </div>
    {% endif %}

</section>
{% endblock %}